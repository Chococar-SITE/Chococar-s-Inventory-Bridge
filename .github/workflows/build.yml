name: Build Multi-Version JAR Files

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: false
        default: 'snapshot'
        type: choice
        options:
        - snapshot
        - release

jobs:
  get-versions:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.versions.outputs.versions }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Get supported versions
      id: versions
      run: |
        python << 'EOF'
        import json
        import os
        
        with open('data/latest_versions.json', 'r') as f:
            versions_data = json.load(f)
        
        complete_versions = [v for v, data in versions_data.items() if data['status'] == 'complete']
        complete_versions.sort(key=lambda x: [int(i) for i in x.split('.')], reverse=True)
        
        print(f"æ”¯æ´çš„ç‰ˆæœ¬: {', '.join(complete_versions)}")
        
        github_output = os.environ.get('GITHUB_OUTPUT')
        if github_output:
            with open(github_output, 'a') as f:
                f.write(f'versions={json.dumps(complete_versions)}\n')
        EOF

  build-matrix:
    needs: get-versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - fabric
          - paper
        mc_version: ${{ fromJson(needs.get-versions.outputs.versions) }}
    
    name: Build ${{ matrix.platform }} for MC ${{ matrix.mc_version }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Validate Gradle wrapper
      uses: gradle/actions/wrapper-validation@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-cleanup: on-success
        
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Load version data for MC ${{ matrix.mc_version }}
      run: |
        echo "ðŸ“‹ è®€å– MC ${{ matrix.mc_version }} ç‰ˆæœ¬æ•¸æ“š..."
        
        # è®€å–ä¸¦è§£æžç‰ˆæœ¬æ•¸æ“š
        python << 'EOF'
        import json
        import os
        
        mc_version = "${{ matrix.mc_version }}"
        
        with open('data/latest_versions.json', 'r') as f:
            versions_data = json.load(f)
        
        if mc_version not in versions_data:
            print(f"âŒ ç‰ˆæœ¬ {mc_version} ä¸å­˜åœ¨æ–¼æ•¸æ“šä¸­")
            exit(1)
        
        data = versions_data[mc_version]
        
        if data['status'] != 'complete':
            print(f"âŒ ç‰ˆæœ¬ {mc_version} ç‹€æ…‹ä¸å®Œæ•´: {data['status']}")
            exit(1)
        
        print(f"ðŸ”§ æ§‹å»º {mc_version}...")
        
        # è¨­å®šåŸºæœ¬ç‰ˆæœ¬è™Ÿ
        if "${{ github.ref }}".startswith("refs/tags/"):
            version = "${{ github.ref }}".split("/")[-1].replace("v", "")
        else:
            version = f"1.0.0-SNAPSHOT+mc{mc_version}"
        
        artifact_name = f"chococars-inventory-bridge-${{ matrix.platform }}-{mc_version}-{version}"
        
        print(f"æ§‹å»ºé…ç½®:")
        print(f"  Minecraft: {mc_version}")
        print(f"  Yarn: {data['yarn_mappings']}")
        print(f"  Fabric API: {data['fabric_api']}")
        print(f"  Paper: {data['paper']}")
        print(f"  Data Version: {data['data_version']}")
        print(f"  Artifact: {artifact_name}")
        
        # è¨­ç½®ç’°å¢ƒè®Šé‡
        with open(os.environ['GITHUB_ENV'], 'a') as env_file:
            env_file.write(f"MC_VERSION={mc_version}\n")
            env_file.write(f"YARN_VERSION={data['yarn_mappings']}\n")
            env_file.write(f"FABRIC_API_VERSION={data['fabric_api']}\n")
            env_file.write(f"PAPER_VERSION={data['paper']}\n")
            env_file.write(f"DATA_VERSION={data['data_version']}\n")
            env_file.write(f"VERSION={version}\n")
            env_file.write(f"ARTIFACT_NAME={artifact_name}\n")
        EOF
        
    - name: Update version configurations
      run: |
        # æ›´æ–° gradle.properties
        cat > gradle.properties << EOF
        org.gradle.jvmargs=-Xmx4G
        minecraft_version=$MC_VERSION
        yarn_mappings=$YARN_VERSION
        loader_version=0.16.9
        mod_version=$VERSION
        maven_group=site.chococar
        archives_base_name=chococars-inventory-bridge
        fabric_version=$FABRIC_API_VERSION
        paper_version=$PAPER_VERSION
        data_version=$DATA_VERSION
        EOF
        
        # æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬
        find . -name "*.yml" -type f -exec sed -i "s/minecraftVersion: \"1.21.8\"/minecraftVersion: \"$MC_VERSION\"/g" {} \;
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ matrix.mc_version }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-${{ matrix.mc_version }}-
          ${{ runner.os }}-gradle-
          
    - name: Build common module
      run: ./gradlew :common:build --no-daemon
      
    - name: Build Fabric mod
      if: matrix.platform == 'fabric'
      run: |
        # æ›´æ–° Fabric ç‰¹å®šç‰ˆæœ¬
        sed -i "s/minecraft \"com.mojang:minecraft:.*\"/minecraft \"com.mojang:minecraft:$MC_VERSION\"/g" fabric/build.gradle
        sed -i "s/mappings \"net.fabricmc:yarn:.*\"/mappings \"net.fabricmc:yarn:$YARN_VERSION:v2\"/g" fabric/build.gradle
        sed -i "s/modImplementation \"net.fabricmc.fabric-api:fabric-api:.*\"/modImplementation \"net.fabricmc.fabric-api:fabric-api:$FABRIC_API_VERSION\"/g" fabric/build.gradle
        
        ./gradlew :fabric:build --no-daemon
        
    - name: Build Paper plugin
      if: matrix.platform == 'paper'
      run: |
        # æ›´æ–° Paper ç‰¹å®šç‰ˆæœ¬
        sed -i "s/paperweight.paperDevBundle(\".*\")/paperweight.paperDevBundle(\"$PAPER_VERSION\")/g" paper/build.gradle
        
        ./gradlew :paper:build --no-daemon
        
    - name: Rename artifacts
      run: |
        if [ "${{ matrix.platform }}" == "fabric" ]; then
          BUILD_DIR="fabric/build/libs"
          ORIGINAL_JAR=$(find $BUILD_DIR -name "*.jar" ! -name "*-dev.jar" ! -name "*-sources.jar" | head -n 1)
        else
          BUILD_DIR="paper/build/libs"
          ORIGINAL_JAR=$(find $BUILD_DIR -name "*.jar" ! -name "*-dev.jar" ! -name "*-sources.jar" | head -n 1)
        fi
        
        if [ -f "$ORIGINAL_JAR" ]; then
          mv "$ORIGINAL_JAR" "$BUILD_DIR/$ARTIFACT_NAME.jar"
          echo "Renamed to: $ARTIFACT_NAME.jar"
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: |
          ${{ matrix.platform }}/build/libs/${{ env.ARTIFACT_NAME }}.jar
        retention-days: 30
        
    - name: Test JAR file
      run: |
        BUILD_DIR="${{ matrix.platform }}/build/libs"
        JAR_FILE="$BUILD_DIR/$ARTIFACT_NAME.jar"
        
        if [ -f "$JAR_FILE" ]; then
          echo "âœ… JAR file created successfully: $JAR_FILE"
          echo "ðŸ“¦ File size: $(du -h "$JAR_FILE" | cut -f1)"
          
          # æª¢æŸ¥ JAR å…§å®¹
          if [ "${{ matrix.platform }}" == "fabric" ]; then
            echo "ðŸ” Checking Fabric mod.json..."
            unzip -l "$JAR_FILE" | grep -E "(fabric.mod.json|mixins.json)" || echo "âš ï¸ Missing Fabric metadata"
          else
            echo "ðŸ” Checking Paper plugin.yml..."
            unzip -l "$JAR_FILE" | grep "paper-plugin.yml" || echo "âš ï¸ Missing Paper plugin.yml"
          fi
        else
          echo "âŒ JAR file not found: $JAR_FILE"
          exit 1
        fi

  create-release:
    needs: [get-versions, build-matrix]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.release_type == 'release'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        files: artifacts/**/*.jar
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Chococar's Inventory Bridge Release
          
          é€™å€‹ç‰ˆæœ¬åŒ…å«å° Minecraft 1.21.4 åˆ° 1.21.8 çš„å®Œæ•´æ”¯æ´ã€‚
          
          ### æ”¯æ´çš„ç‰ˆæœ¬
          - Minecraft 1.21.4, 1.21.5, 1.21.6, 1.21.7, 1.21.8
          - Java 21+
          
          ### å¹³å°æ”¯æ´
          - âœ… Fabric æ¨¡çµ„
          - âœ… Paper æ’ä»¶
          
          ### å®‰è£èªªæ˜Ž
          1. é¸æ“‡å°æ‡‰æ‚¨çš„ Minecraft ç‰ˆæœ¬å’Œå¹³å°çš„ JAR æ–‡ä»¶
          2. å°‡ JAR æ–‡ä»¶æ”¾å…¥å°æ‡‰çš„ `mods/` æˆ– `plugins/` è³‡æ–™å¤¾
          3. é…ç½® MySQL è³‡æ–™åº«é€£æŽ¥
          4. é‡å•Ÿä¼ºæœå™¨
          
          ### æ–‡ä»¶ä¸‹è¼‰èªªæ˜Ž
          - `*-fabric-*.jar` - Fabric æ¨¡çµ„æ–‡ä»¶
          - `*-paper-*.jar` - Paper æ’ä»¶æ–‡ä»¶
          - æ–‡ä»¶ååŒ…å«å°æ‡‰çš„ Minecraft ç‰ˆæœ¬è™Ÿ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    needs: [get-versions, build-matrix, create-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Clean up
      run: |
        echo "ðŸ§¹ æ§‹å»ºå®Œæˆï¼Œæ¸…ç†å·¥ä½œç©ºé–“"
        echo "ðŸ“Š æ§‹å»ºæ‘˜è¦ï¼š"
        echo "   - æ”¯æ´ç‰ˆæœ¬: 1.21.4, 1.21.5, 1.21.6, 1.21.7, 1.21.8"
        echo "   - å¹³å°: Fabric + Paper"
        echo "   - ç¸½è¨ˆ JAR æ–‡ä»¶: 10 å€‹"