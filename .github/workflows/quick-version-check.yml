name: Quick Version Check

on:
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æª¢æŸ¥é¡žåž‹'
        required: true
        default: 'current'
        type: choice
        options:
        - current
        - latest
        - specific
      specific_versions:
        description: 'æŒ‡å®šç‰ˆæœ¬ (ç”¨ç©ºæ ¼åˆ†éš”ï¼Œåƒ…ç•¶æª¢æŸ¥é¡žåž‹ç‚º specific æ™‚)'
        required: false
        type: string

jobs:
  quick-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Check current versions in workflow
      if: github.event.inputs.check_type == 'current'
      run: |
        echo "ðŸ“‹ ç•¶å‰å·¥ä½œæµç¨‹æ”¯æ´çš„ç‰ˆæœ¬:"
        grep -E '"1\.21\.\d+"' .github/workflows/build.yml | sed 's/.*"\(1\.21\.[0-9]*\)".*/\1/' | sort -V
        
        echo -e "\nðŸ“‹ ç•¶å‰ gradle.properties ç‰ˆæœ¬:"
        grep "minecraft_version" gradle.properties
        grep "yarn_mappings" gradle.properties
        grep "fabric_version" gradle.properties
        grep "paper_version" gradle.properties
        grep "data_version" gradle.properties
        
    - name: Check latest available versions
      if: github.event.inputs.check_type == 'latest'
      run: |
        echo "ðŸ” æª¢æŸ¥æœ€æ–°å¯ç”¨ç‰ˆæœ¬..."
        node scripts/check-versions.js --json
        
    - name: Check specific versions
      if: github.event.inputs.check_type == 'specific'
      run: |
        if [ -z "${{ github.event.inputs.specific_versions }}" ]; then
          echo "âŒ è«‹æŒ‡å®šè¦æª¢æŸ¥çš„ç‰ˆæœ¬"
          exit 1
        fi
        
        echo "ðŸ” æª¢æŸ¥æŒ‡å®šç‰ˆæœ¬: ${{ github.event.inputs.specific_versions }}"
        node scripts/check-versions.js ${{ github.event.inputs.specific_versions }} --json
        
    - name: Generate comparison report
      if: github.event.inputs.check_type == 'latest'
      run: |
        echo "ðŸ“Š ç”Ÿæˆæ¯”è¼ƒå ±å‘Š..."
        
        # ç²å–ç•¶å‰ç‰ˆæœ¬
        current_versions=$(grep -E '"1\.21\.\d+"' .github/workflows/build.yml | sed 's/.*"\(1\.21\.[0-9]*\)".*/\1/' | sort -V | tr '\n' ' ')
        
        # ç²å–æœ€æ–°ç‰ˆæœ¬
        node scripts/check-versions.js --json > latest.json
        latest_versions=$(node -e "
          const data = JSON.parse(require('fs').readFileSync('latest.json', 'utf8'));
          const complete = Object.keys(data).filter(v => data[v].status === 'complete').sort();
          console.log(complete.join(' '));
        ")
        
        echo "ðŸ“‹ ç‰ˆæœ¬æ¯”è¼ƒ:"
        echo "ç•¶å‰æ”¯æ´: $current_versions"
        echo "æœ€æ–°å¯ç”¨: $latest_versions"
        
        # æª¢æŸ¥å·®ç•°
        node -e "
          const current = '$current_versions'.trim().split(' ').filter(v => v);
          const latest = '$latest_versions'.trim().split(' ').filter(v => v);
          
          const missing = latest.filter(v => !current.includes(v));
          const deprecated = current.filter(v => !latest.includes(v));
          
          console.log('\\nðŸ†• æ–°ç‰ˆæœ¬:', missing.length > 0 ? missing.join(', ') : 'ç„¡');
          console.log('âš ï¸ å¯èƒ½å·²éŽæ™‚:', deprecated.length > 0 ? deprecated.join(', ') : 'ç„¡');
          
          if (missing.length > 0) {
            console.log('\\nðŸ’¡ å»ºè­°åŸ·è¡Œè‡ªå‹•æ›´æ–°å·¥ä½œæµç¨‹');
          }
        "
        
    - name: Create summary
      run: |
        echo "## ðŸ” ç‰ˆæœ¬æª¢æŸ¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æª¢æŸ¥é¡žåž‹:** ${{ github.event.inputs.check_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**æª¢æŸ¥æ™‚é–“:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.check_type }}" == "current" ]; then
          echo "### ç•¶å‰é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -E '"1\.21\.\d+"' .github/workflows/build.yml | sed 's/.*"\(1\.21\.[0-9]*\)".*/\1/' | sort -V >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ç›¸é—œé€£çµ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [è‡ªå‹•æ›´æ–°å·¥ä½œæµç¨‹](https://github.com/${{ github.repository }}/actions/workflows/auto-update-versions.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- [æ§‹å»ºå·¥ä½œæµç¨‹](https://github.com/${{ github.repository }}/actions/workflows/build.yml)" >> $GITHUB_STEP_SUMMARY
        echo "- [ç‰ˆæœ¬è…³æœ¬](https://github.com/${{ github.repository }}/blob/main/scripts/)" >> $GITHUB_STEP_SUMMARY