name: Auto Update Versions

on:
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 8:00 UTC åŸ·è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°ç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      target_versions:
        description: 'æŒ‡å®šç‰ˆæœ¬ (ç”¨ç©ºæ ¼åˆ†éš”ï¼Œå¦‚: 1.21.6 1.21.7)'
        required: false
        type: string

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      new_versions: ${{ steps.check.outputs.new_versions }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Check for new versions
      id: check
      run: |
        echo "ğŸ” æª¢æŸ¥æœ€æ–°ç‰ˆæœ¬..."
        
        # åŸ·è¡Œç‰ˆæœ¬æª¢æŸ¥è…³æœ¬
        if [ -n "${{ github.event.inputs.target_versions }}" ]; then
          python scripts/fetch-latest-versions.py --versions ${{ github.event.inputs.target_versions }} --output json > latest_versions.json
        else
          python scripts/fetch-latest-versions.py --output json > latest_versions.json
        fi
        
        # æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
        python << 'EOF'
        import json
        import re
        
        # è®€å–æœ€æ–°ç‰ˆæœ¬æ•¸æ“š
        with open('latest_versions.json', 'r') as f:
            latest_data = json.load(f)
        
        # è®€å–ç•¶å‰ build.yml ä¸­çš„ç‰ˆæœ¬
        with open('.github/workflows/build.yml', 'r') as f:
            build_content = f.read()
        
        # æå–ç•¶å‰æ”¯æ´çš„ç‰ˆæœ¬
        current_versions = re.findall(r'"(1\.21\.\d+)"', build_content)
        current_versions = set(current_versions)
        
        # æª¢æŸ¥æ–°ç‰ˆæœ¬
        latest_versions = set(latest_data.keys())
        new_versions = latest_versions - current_versions
        
        print(f"ç›®å‰ç‰ˆæœ¬: {sorted(current_versions)}")
        print(f"æœ€æ–°ç‰ˆæœ¬: {sorted(latest_versions)}")
        print(f"æ–°ç‰ˆæœ¬: {sorted(new_versions)}")
        
        has_updates = len(new_versions) > 0 or "${{ github.event.inputs.force_update }}" == "true"
        
        # è¼¸å‡ºçµæœ
        with open('$GITHUB_OUTPUT', 'a') as f:
            f.write(f"has_updates={str(has_updates).lower()}\n")
            f.write(f"new_versions={' '.join(sorted(new_versions))}\n")
        
        print(f"æœ‰æ›´æ–°: {has_updates}")
        if new_versions:
            print(f"æ–°ç‰ˆæœ¬: {', '.join(sorted(new_versions))}")
        EOF
        
    - name: Upload version data
      if: steps.check.outputs.has_updates == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: latest-versions
        path: latest_versions.json
        retention-days: 1

  update-workflows:
    needs: check-versions
    if: needs.check-versions.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Download version data
      uses: actions/download-artifact@v4
      with:
        name: latest-versions
        
    - name: Update workflow files
      run: |
        echo "ğŸ”„ æ›´æ–°å·¥ä½œæµç¨‹æ–‡ä»¶..."
        
        python << 'EOF'
        import json
        import re
        
        # è®€å–ç‰ˆæœ¬æ•¸æ“š
        with open('latest_versions.json', 'r') as f:
            versions_data = json.load(f)
        
        # ç”Ÿæˆæ–°çš„ç‰ˆæœ¬çŸ©é™£
        complete_versions = [v for v, data in versions_data.items() if data['status'] == 'complete']
        complete_versions.sort(key=lambda x: [int(i) for i in x.split('.')], reverse=True)
        
        print(f"å®Œæ•´æ”¯æ´çš„ç‰ˆæœ¬: {complete_versions}")
        
        # æ›´æ–° build.yml
        with open('.github/workflows/build.yml', 'r') as f:
            content = f.read()
        
        # æ›´æ–°ç‰ˆæœ¬çŸ©é™£
        matrix_versions = '\n'.join([f'          - "{v}"' for v in complete_versions])
        content = re.sub(
            r'minecraft_version:\s*\n(\s*-\s*"1\.21\.\d+"\s*\n)+',
            f'minecraft_version: \n{matrix_versions}\n',
            content
        )
        
        # æ›´æ–°ç‰ˆæœ¬é…ç½® case èªå¥
        cases = []
        for version, data in versions_data.items():
            if data['status'] != 'complete':
                continue
            case = f'''          "{version}")
            echo "YARN_VERSION={data['yarn_mappings']}" >> $GITHUB_ENV
            echo "FABRIC_API_VERSION={data['fabric_api']}" >> $GITHUB_ENV
            echo "PAPER_VERSION={data['paper']}" >> $GITHUB_ENV
            echo "DATA_VERSION={data['data_version']}" >> $GITHUB_ENV
            ;;'''
            cases.append(case)
        
        cases_content = '\n'.join(cases)
        
        # æ›¿æ› case èªå¥
        content = re.sub(
            r'case "\$MC_VERSION" in\n.*?\nesac',
            f'case "$MC_VERSION" in\n{cases_content}\n        esac',
            content,
            flags=re.DOTALL
        )
        
        with open('.github/workflows/build.yml', 'w') as f:
            f.write(content)
        
        # æ›´æ–° gradle.propertiesï¼ˆä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ä½œç‚ºé è¨­ï¼‰
        latest_version = complete_versions[0]
        latest_data = versions_data[latest_version]
        
        gradle_content = f"""# Done to increase the memory available to gradle.
org.gradle.jvmargs=-Xmx4G

# Fabric Properties (auto-updated)
minecraft_version={latest_version}
yarn_mappings={latest_data['yarn_mappings']}
loader_version=0.16.9

# Mod Properties
mod_version=1.0.0-SNAPSHOT
maven_group=site.chococar
archives_base_name=chococars-inventory-bridge

# Dependencies
fabric_version={latest_data['fabric_api']}
paper_version={latest_data['paper']}
data_version={latest_data['data_version']}

# CI/CD Properties
ci_build=false"""
        
        with open('gradle.properties', 'w') as f:
            f.write(gradle_content)
        
        print("âœ… æ–‡ä»¶æ›´æ–°å®Œæˆ")
        EOF
        
    - name: Update version scripts
      run: |
        echo "ğŸ”„ æ›´æ–°ç‰ˆæœ¬è…³æœ¬..."
        
        python << 'EOF'
        import json
        from datetime import datetime
        
        with open('latest_versions.json', 'r') as f:
            versions_data = json.load(f)
        
        complete_versions = [v for v, data in versions_data.items() if data['status'] == 'complete']
        complete_versions.sort(key=lambda x: [int(i) for i in x.split('.')])
        
        # ç”Ÿæˆ shell è…³æœ¬
        cases = []
        for version in complete_versions:
            data = versions_data[version]
            case = f'''  "{version}")
    YARN_VERSION="{data['yarn_mappings']}"
    FABRIC_API_VERSION="{data['fabric_api']}"
    PAPER_VERSION="{data['paper']}"
    DATA_VERSION="{data['data_version']}"
    ;;'''
            cases.append(case)
        
        versions_str = ', '.join(complete_versions)
        cases_content = '\n'.join(cases)
        
        shell_script = f'''#!/bin/bash

# è‡ªå‹•ç”Ÿæˆçš„ç‰ˆæœ¬æ›´æ–°è…³æœ¬ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
# æ”¯æ´ç‰ˆæœ¬: {versions_str}

set -e

MC_VERSION=${{1:-"{complete_versions[-1]}"}}

case "$MC_VERSION" in
{cases_content}
  *)
    echo "âŒ ä¸æ”¯æ´çš„ç‰ˆæœ¬: $MC_VERSION"
    echo "æ”¯æ´çš„ç‰ˆæœ¬: {versions_str}"
    exit 1
    ;;
esac

echo "ğŸ”§ æ­£åœ¨æ›´æ–°åˆ° Minecraft $MC_VERSION..."

# æ›´æ–° gradle.properties
cat > gradle.properties << EOF
# Done to increase the memory available to gradle.
org.gradle.jvmargs=-Xmx4G

# Fabric Properties
minecraft_version=$MC_VERSION
yarn_mappings=$YARN_VERSION
loader_version=0.16.9

# Mod Properties
mod_version=1.0.0-SNAPSHOT
maven_group=site.chococar
archives_base_name=chococars-inventory-bridge

# Dependencies
fabric_version=$FABRIC_API_VERSION
paper_version=$PAPER_VERSION
data_version=$DATA_VERSION

# CI/CD Properties
ci_build=false
EOF

# æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬
echo "ğŸ“ æ›´æ–°é…ç½®æ–‡ä»¶..."
find . -name "*.yml" -type f -not -path "./.git/*" -exec sed -i.bak "s/minecraftVersion: \\".*\\"/minecraftVersion: \\"$MC_VERSION\\"/g" {{}} \\;

# æ¸…ç†å‚™ä»½æ–‡ä»¶
find . -name "*.yml.bak" -delete

# æ›´æ–°å¸¸é‡æ–‡ä»¶ä¸­çš„æ•¸æ“šç‰ˆæœ¬
echo "ğŸ”¢ æ›´æ–°æ•¸æ“šç‰ˆæœ¬..."
find . -name "*.java" -type f -exec sed -i.bak "s/CURRENT_DATA_VERSION = [0-9]*/CURRENT_DATA_VERSION = $DATA_VERSION/g" {{}} \\;
find . -name "*.java.bak" -delete

echo "âœ… ç‰ˆæœ¬æ›´æ–°å®Œæˆï¼"
echo "ğŸ“‹ ç•¶å‰é…ç½®ï¼š"
echo "   Minecraft: $MC_VERSION"
echo "   Yarn: $YARN_VERSION"
echo "   Fabric API: $FABRIC_API_VERSION"
echo "   Paper: $PAPER_VERSION"
echo "   Data Version: $DATA_VERSION"
echo ""
echo "ğŸš€ ç¾åœ¨å¯ä»¥é‹è¡Œ './gradlew build' ä¾†æ§‹å»ºå°ˆæ¡ˆ"'''
        
        with open('scripts/update-version.sh', 'w') as f:
            f.write(shell_script)
        
        print("âœ… è…³æœ¬æ›´æ–°å®Œæˆ")
        EOF
        
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        
        if git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
        else
          echo "æäº¤ç‰ˆæœ¬æ›´æ–°..."
          git commit -m "ğŸ”„ è‡ªå‹•æ›´æ–°ç‰ˆæœ¬ API

          æ–°ç‰ˆæœ¬: ${{ needs.check-versions.outputs.new_versions }}
          æ›´æ–°æ™‚é–“: $(date -u)
          
          - æ›´æ–° GitHub Actions å·¥ä½œæµç¨‹
          - æ›´æ–° gradle.properties
          - æ›´æ–°ç‰ˆæœ¬è…³æœ¬
          
          ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ"
          
          git push
          
          echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤"
        fi
        
    - name: Create issue for new versions
      if: needs.check-versions.outputs.new_versions != ''
      uses: actions/github-script@v7
      with:
        script: |
          const newVersions = "${{ needs.check-versions.outputs.new_versions }}".split(' ').filter(v => v);
          
          if (newVersions.length > 0) {
            const issueBody = `
          ## ğŸ‰ åµæ¸¬åˆ°æ–°çš„ Minecraft ç‰ˆæœ¬

          **æ–°ç‰ˆæœ¬:** ${newVersions.join(', ')}

          ### è‡ªå‹•æ›´æ–°å…§å®¹
          - âœ… æ›´æ–° GitHub Actions å·¥ä½œæµç¨‹ç‰ˆæœ¬çŸ©é™£
          - âœ… æ›´æ–° gradle.properties é è¨­ç‰ˆæœ¬
          - âœ… æ›´æ–°ç‰ˆæœ¬åˆ‡æ›è…³æœ¬

          ### éœ€è¦æ‰‹å‹•æª¢æŸ¥
          - [ ] é©—è­‰æ–°ç‰ˆæœ¬çš„ä¾è³´å¯ç”¨æ€§
          - [ ] æ¸¬è©¦æ§‹å»ºæµç¨‹
          - [ ] æ›´æ–°æ–‡æª”ä¸­çš„ç‰ˆæœ¬èªªæ˜
          - [ ] ç¢ºèªå…¼å®¹æ€§è™•ç†æ˜¯å¦éœ€è¦èª¿æ•´

          ### ç›¸é—œé€£çµ
          - [æ§‹å»ºå·¥ä½œæµç¨‹](https://github.com/${{ github.repository }}/actions/workflows/build.yml)
          - [ç‰ˆæœ¬è…³æœ¬](https://github.com/${{ github.repository }}/blob/main/scripts/update-version.sh)

          ---
          *æ­¤ issue ç”± GitHub Actions è‡ªå‹•å‰µå»ºæ–¼ ${new Date().toISOString()}*
          `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ æ–° Minecraft ç‰ˆæœ¬: ${newVersions.join(', ')}`,
              body: issueBody,
              labels: ['enhancement', 'auto-update', 'version-update']
            });
          }

  test-build:
    needs: [check-versions, update-workflows]
    if: needs.check-versions.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout updated repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        
    - name: Test build with new versions
      run: |
        echo "ğŸ§ª æ¸¬è©¦æ–°ç‰ˆæœ¬æ§‹å»º..."
        
        # ç°¡å–®çš„èªæ³•æª¢æŸ¥
        if ! grep -q "minecraft_version:" gradle.properties; then
          echo "âŒ gradle.properties æ ¼å¼éŒ¯èª¤"
          exit 1
        fi
        
        if ! grep -q "minecraft_version:" .github/workflows/build.yml; then
          echo "âŒ build.yml æ ¼å¼éŒ¯èª¤"
          exit 1
        fi
        
        echo "âœ… æ–‡ä»¶æ ¼å¼æª¢æŸ¥é€šé"
        
        # è§¸ç™¼æ¸¬è©¦æ§‹å»ºï¼ˆå¯é¸ï¼‰
        if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
          echo "ğŸš€ è§¸ç™¼æ¸¬è©¦æ§‹å»º..."
          # é€™è£¡å¯ä»¥è§¸ç™¼å¯¦éš›çš„æ§‹å»ºæ¸¬è©¦
        fi