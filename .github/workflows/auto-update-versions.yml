name: Auto Update Versions
permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 8:00 UTC åŸ·è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°ç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      target_versions:
        description: 'æŒ‡å®šç‰ˆæœ¬ (ç”¨ç©ºæ ¼åˆ†éš”ï¼Œå¦‚: 1.21.6 1.21.7)'
        required: false
        type: string

jobs:
  check-and-update-versions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Fetch and check for updates
      id: check
      run: |
        echo "ğŸ” ç²å–æœ€æ–°ç‰ˆæœ¬æ•¸æ“š..."
        
        # å‹•æ…‹ç²å–æœ€æ–°ç‰ˆæœ¬æ•¸æ“š
        python scripts/fetch-latest-versions.py --output json > new_versions.json
        
        # å¦‚æœå‹•æ…‹ç²å–å¤±æ•—ï¼Œä½¿ç”¨ç¾æœ‰æ•¸æ“š
        if [ ! -s new_versions.json ] || ! python -m json.tool new_versions.json > /dev/null 2>&1; then
          echo "âš ï¸ å‹•æ…‹ç²å–å¤±æ•—ï¼Œä½¿ç”¨ç¾æœ‰æ•¸æ“š..."
          cp data/latest_versions.json new_versions.json
        else
          echo "âœ… æˆåŠŸç²å–æœ€æ–°ç‰ˆæœ¬æ•¸æ“š"
        fi
        
        # æ¯”è¼ƒç‰ˆæœ¬å·®ç•°
        python << 'EOF'
        import json
        import os
        
        # è®€å–æ–°èˆŠç‰ˆæœ¬æ•¸æ“š
        with open('new_versions.json', 'r') as f:
            new_data = json.load(f)
        
        try:
            with open('data/latest_versions.json', 'r') as f:
                old_data = json.load(f)
        except FileNotFoundError:
            old_data = {}
        
        # æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        has_updates = False
        updates = []
        
        for version, new_info in new_data.items():
            if version not in old_data:
                updates.append(f"{version}(NEW)")
                has_updates = True
            else:
                old_info = old_data[version]
                changes = []
                for key in ['yarn_mappings', 'fabric_api', 'paper', 'data_version']:
                    if old_info.get(key) != new_info.get(key):
                        changes.append(key)
                        has_updates = True
                
                if changes:
                    updates.append(f"{version}({','.join(changes)})")
        
        # å¼·åˆ¶æ›´æ–°æª¢æŸ¥
        if '${{ github.event.inputs.force_update }}' == 'true':
            has_updates = True
            updates.append("FORCE")
        
        # è¼¸å‡ºçµæœ
        github_output = os.environ.get('GITHUB_OUTPUT')
        if github_output:
            with open(github_output, 'a') as f:
                f.write(f'has_updates={str(has_updates).lower()}\n')
                f.write(f'updates={" ".join(updates)}\n')
        
        print(f'æœ‰æ›´æ–°: {has_updates}')
        print(f'æ›´æ–°é …ç›®: {", ".join(updates) if updates else "ç„¡"}')
        EOF
        
    - name: Create Pull Request for updates
      if: steps.check.outputs.has_updates == 'true'
      run: |
        # è¨­ç½® Git é…ç½®
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ›´æ–°æ•¸æ“šæ–‡ä»¶
        cp new_versions.json data/latest_versions.json
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --quiet data/latest_versions.json; then
          echo "æ•¸æ“šæ–‡ä»¶æ²’æœ‰è®Šæ›´"
          exit 0
        fi
        
        # å‰µå»ºæ–°åˆ†æ”¯
        BRANCH_NAME="auto-update-versions-$(date +%Y%m%d-%H%M%S)"
        echo "ğŸŒ¿ å‰µå»ºåˆ†æ”¯: $BRANCH_NAME"
        git checkout -b "$BRANCH_NAME"
        
        # æäº¤è®Šæ›´
        git add data/latest_versions.json
        git commit -m "ğŸ”„ è‡ªå‹•æ›´æ–°ç‰ˆæœ¬æ•¸æ“š

        æ›´æ–°é …ç›®: ${{ steps.check.outputs.updates }}
        æ›´æ–°æ™‚é–“: $(date -u)
        
        - æ›´æ–° data/latest_versions.json
        
        ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ"
        
        # æ¨é€åˆ†æ”¯
        echo "ğŸ“¤ æ¨é€åˆ†æ”¯..."
        git push origin "$BRANCH_NAME"
        
        # å‰µå»º PR
        echo "ğŸ”ƒ å‰µå»º Pull Request..."
        gh pr create \
          --title "ğŸ”„ è‡ªå‹•æ›´æ–°ç‰ˆæœ¬æ•¸æ“š - ${{ steps.check.outputs.updates }}" \
          --body "## ğŸ¯ è‡ªå‹•ç‰ˆæœ¬æ•¸æ“šæ›´æ–°

        **æ›´æ–°é …ç›®:** ${{ steps.check.outputs.updates }}

        ### ğŸ“‹ è®Šæ›´å…§å®¹
        - âœ… æ›´æ–° \`data/latest_versions.json\` ç‰ˆæœ¬æ•¸æ“š
        - ğŸ”„ æ‰€æœ‰å·¥ä½œæµç¨‹å°‡è‡ªå‹•ä½¿ç”¨æ–°ç‰ˆæœ¬æ•¸æ“š

        ### ğŸš€ ä¸‹ä¸€æ­¥
        - [ ] å¯©æŸ¥ç‰ˆæœ¬è®Šæ›´
        - [ ] æ¸¬è©¦æ§‹å»ºæµç¨‹
        - [ ] åˆä½µ PR

        ---
        *æ­¤ PR ç”± GitHub Actions è‡ªå‹•å‰µå»ºæ–¼ $(date -u)*" \
          --assignee "@me" \
          --label "enhancement,auto-update,version-update"
        
        echo "âœ… Pull Request å·²å‰µå»º"