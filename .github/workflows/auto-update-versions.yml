name: Auto Update Versions

on:
  schedule:
    # æ¯é€±ä¸€æ—©ä¸Š 8:00 UTC åŸ·è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°ç‰ˆæœ¬'
        required: false
        default: false
        type: boolean
      target_versions:
        description: 'æŒ‡å®šç‰ˆæœ¬ (ç”¨ç©ºæ ¼åˆ†éš”ï¼Œå¦‚: 1.21.6 1.21.7)'
        required: false
        type: string

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      new_versions: ${{ steps.check.outputs.new_versions }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Check for new versions
      id: check
      run: |
        echo "ğŸ” æª¢æŸ¥æœ€æ–°ç‰ˆæœ¬..."
        
        # åŸ·è¡Œç‰ˆæœ¬æª¢æŸ¥è…³æœ¬
        if [ -n "${{ github.event.inputs.target_versions }}" ]; then
          if ! python scripts/fetch-latest-versions.py --versions ${{ github.event.inputs.target_versions }} --output json > latest_versions.json; then
            echo "âŒ ç‰ˆæœ¬æª¢æŸ¥è…³æœ¬åŸ·è¡Œå¤±æ•—"
            exit 1
          fi
        else
          if ! python scripts/fetch-latest-versions.py --output json > latest_versions.json; then
            echo "âŒ ç‰ˆæœ¬æª¢æŸ¥è…³æœ¬åŸ·è¡Œå¤±æ•—"
            exit 1
          fi
        fi
        
        # æª¢æŸ¥ç”Ÿæˆçš„ JSON æ–‡ä»¶
        if [ ! -f "latest_versions.json" ] || [ ! -s "latest_versions.json" ]; then
          echo "âŒ latest_versions.json æ–‡ä»¶æœªç”Ÿæˆæˆ–ç‚ºç©º"
          exit 1
        fi
        
        echo "âœ… ç‰ˆæœ¬æ•¸æ“šç²å–æˆåŠŸ"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
        python -c "
        import json
        import re
        
        # è®€å–æœ€æ–°ç‰ˆæœ¬æ•¸æ“š
        try:
            with open('latest_versions.json', 'r') as f:
                content = f.read().strip()
                if not content:
                    print('âŒ latest_versions.json æ–‡ä»¶ç‚ºç©º')
                    exit(1)
                latest_data = json.loads(content)
        except FileNotFoundError:
            print('âŒ latest_versions.json æ–‡ä»¶ä¸å­˜åœ¨')
            exit(1)
        except json.JSONDecodeError as e:
            print(f'âŒ JSON è§£æéŒ¯èª¤: {e}')
            exit(1)
        
        # è®€å–ç•¶å‰ build.yml ä¸­çš„ç‰ˆæœ¬
        with open('.github/workflows/build.yml', 'r') as f:
            build_content = f.read()
        
        # æå–ç•¶å‰æ”¯æ´çš„ç‰ˆæœ¬
        current_versions = re.findall(r'\"(1\.21\.\d+)\"', build_content)
        current_versions = set(current_versions)
        
        # æª¢æŸ¥æ–°ç‰ˆæœ¬
        latest_versions = set(latest_data.keys())
        new_versions = latest_versions - current_versions
        
        print(f'ç›®å‰ç‰ˆæœ¬: {sorted(current_versions)}')
        print(f'æœ€æ–°ç‰ˆæœ¬: {sorted(latest_versions)}')
        print(f'æ–°ç‰ˆæœ¬: {sorted(new_versions)}')
        
        has_updates = len(new_versions) > 0 or '${{ github.event.inputs.force_update }}' == 'true'
        
        # è¼¸å‡ºçµæœ
        with open('$GITHUB_OUTPUT', 'a') as f:
            f.write(f'has_updates={str(has_updates).lower()}\n')
            f.write(f'new_versions={\" \".join(sorted(new_versions))}\n')
        
        print(f'æœ‰æ›´æ–°: {has_updates}')
        if new_versions:
            print(f'æ–°ç‰ˆæœ¬: {\", \".join(sorted(new_versions))}')
        "
        
    - name: Upload version data
      if: steps.check.outputs.has_updates == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: latest-versions
        path: latest_versions.json
        retention-days: 1

  update-workflows:
    needs: check-versions
    if: needs.check-versions.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Download version data
      uses: actions/download-artifact@v4
      with:
        name: latest-versions
        
    - name: Update workflow files
      run: |
        echo "ğŸ”„ æ›´æ–°å·¥ä½œæµç¨‹æ–‡ä»¶..."
        
        cat > update_workflows.py << 'SCRIPT_EOF'
        import json
        import re
        
        # è®€å–ç‰ˆæœ¬æ•¸æ“š
        try:
            with open('latest_versions.json', 'r') as f:
                content = f.read().strip()
                if not content:
                    print('âŒ latest_versions.json æ–‡ä»¶ç‚ºç©º')
                    exit(1)
                versions_data = json.loads(content)
        except FileNotFoundError:
            print('âŒ latest_versions.json æ–‡ä»¶ä¸å­˜åœ¨')
            exit(1)
        except json.JSONDecodeError as e:
            print(f'âŒ JSON è§£æéŒ¯èª¤: {e}')
            exit(1)
        
        # ç”Ÿæˆæ–°çš„ç‰ˆæœ¬çŸ©é™£
        complete_versions = [v for v, data in versions_data.items() if data['status'] == 'complete']
        complete_versions.sort(key=lambda x: [int(i) for i in x.split('.')], reverse=True)
        
        print(f"å®Œæ•´æ”¯æ´çš„ç‰ˆæœ¬: {complete_versions}")
        
        # æ›´æ–° build.yml
        with open('.github/workflows/build.yml', 'r') as f:
            content = f.read()
        
        # æ›´æ–°ç‰ˆæœ¬çŸ©é™£
        matrix_versions = '\n'.join([f'          - "{v}"' for v in complete_versions])
        content = re.sub(
            r'minecraft_version:\s*\n(\s*-\s*"1\.21\.\d+"\s*\n)+',
            f'minecraft_version: \n{matrix_versions}\n',
            content
        )
        
        # æ›´æ–°ç‰ˆæœ¬é…ç½® case èªå¥
        cases = []
        for version, data in versions_data.items():
            if data['status'] != 'complete':
                continue
            case = f'          "{version}")\n            echo "YARN_VERSION={data["yarn_mappings"]}" >> $GITHUB_ENV\n            echo "FABRIC_API_VERSION={data["fabric_api"]}" >> $GITHUB_ENV\n            echo "PAPER_VERSION={data["paper"]}" >> $GITHUB_ENV\n            echo "DATA_VERSION={data["data_version"]}" >> $GITHUB_ENV\n            ;;'
            cases.append(case)
        
        cases_content = '\n'.join(cases)
        
        # æ›¿æ› case èªå¥
        content = re.sub(
            r'case "\$MC_VERSION" in\n.*?\nesac',
            f'case "$MC_VERSION" in\n{cases_content}\n        esac',
            content,
            flags=re.DOTALL
        )
        
        with open('.github/workflows/build.yml', 'w') as f:
            f.write(content)
        
        # æ›´æ–° gradle.propertiesï¼ˆä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ä½œç‚ºé è¨­ï¼‰
        latest_version = complete_versions[0]
        latest_data = versions_data[latest_version]
        
        gradle_content = "# Done to increase the memory available to gradle.\\n"
        gradle_content += "org.gradle.jvmargs=-Xmx4G\\n\\n"
        gradle_content += "# Fabric Properties (auto-updated)\\n"
        gradle_content += f"minecraft_version={latest_version}\\n"
        gradle_content += f"yarn_mappings={latest_data['yarn_mappings']}\\n"
        gradle_content += "loader_version=0.16.9\\n\\n"
        gradle_content += "# Mod Properties\\n"
        gradle_content += "mod_version=1.0.0-SNAPSHOT\\n"
        gradle_content += "maven_group=site.chococar\\n"
        gradle_content += "archives_base_name=chococars-inventory-bridge\\n\\n"
        gradle_content += "# Dependencies\\n"
        gradle_content += f"fabric_version={latest_data['fabric_api']}\\n"
        gradle_content += f"paper_version={latest_data['paper']}\\n"
        gradle_content += f"data_version={latest_data['data_version']}\\n\\n"
        gradle_content += "# CI/CD Properties\\n"
        gradle_content += "ci_build=false"
        
        with open('gradle.properties', 'w') as f:
            f.write(gradle_content)
        
        # æ›´æ–° README.md
        print("ğŸ“ æ›´æ–° README.md...")
        try:
            with open('README.md', 'r', encoding='utf-8') as f:
                readme_content = f.read()
            
            # æ›´æ–°æ”¯æ´çš„ç‰ˆæœ¬åˆ—è¡¨
            versions_list = ', '.join([f'1.21.{i}' for i in sorted([int(v.split('.')[2]) for v in complete_versions])])
            version_range = f"1.21.{min([int(v.split('.')[2]) for v in complete_versions])} - 1.21.{max([int(v.split('.')[2]) for v in complete_versions])}"
            
            # æ›´æ–°ä¸»è¦ç‰ˆæœ¬ä¿¡æ¯
            latest_mc = complete_versions[0]
            latest_fabric_api = latest_data['fabric_api']
            latest_paper = latest_data['paper']
            
            # æ›¿æ›ç‰ˆæœ¬ç›¸é—œå…§å®¹
            import re
            
            # æ›´æ–°ç‰ˆæœ¬å…¼å®¹æ€§è¡Œ
            readme_content = re.sub(
                r'å®Œå…¨æ”¯æ´ Minecraft 1\.21\.X ç‰ˆæœ¬ï¼ˆ.*?ï¼‰',
                f'å®Œå…¨æ”¯æ´ Minecraft 1.21.X ç‰ˆæœ¬ï¼ˆ{version_range}ï¼‰',
                readme_content
            )
            
            # æ›´æ–°ç•¶å‰æ”¯æ´ç‰ˆæœ¬
            readme_content = re.sub(
                r'- \*\*Minecraft 1\.21\.\d+\*\*ï¼ˆå®Œæ•´æ”¯æ´ï¼‰',
                f'- **Minecraft {latest_mc}**ï¼ˆå®Œæ•´æ”¯æ´ï¼‰',
                readme_content
            )
            
            # æ›´æ–°ç³»çµ±éœ€æ±‚ä¸­çš„ç‰ˆæœ¬
            readme_content = re.sub(
                r'- Fabric API 0\.\d+\.\d+\+',
                f'- Fabric API {latest_fabric_api}+',
                readme_content
            )
            
            readme_content = re.sub(
                r'- Minecraft 1\.21\.\d+',
                f'- Minecraft {latest_mc}',
                readme_content
            )
            
            readme_content = re.sub(
                r'- Paper 1\.21\.\d+\+',
                f'- Paper {latest_paper}+',
                readme_content
            )
            
            # æ·»åŠ æ›´æ–°æ™‚é–“æˆ³
            from datetime import datetime
            update_time = datetime.now().strftime('%Y-%m-%d')
            
            # å¦‚æœæ²’æœ‰æ›´æ–°æ™‚é–“æˆ³éƒ¨åˆ†ï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ 
            if '<!-- Auto-updated -->' not in readme_content:
                readme_content += f'\\n\\n<!-- Auto-updated by GitHub Actions on {update_time} -->'
            else:
                readme_content = re.sub(
                    r'<!-- Auto-updated by GitHub Actions on .*? -->',
                    f'<!-- Auto-updated by GitHub Actions on {update_time} -->',
                    readme_content
                )
            
            with open('README.md', 'w', encoding='utf-8') as f:
                f.write(readme_content)
            
            print(f"âœ… README.md å·²æ›´æ–°ï¼ˆæ”¯æ´ç‰ˆæœ¬ï¼š{versions_list}ï¼‰")
            
        except Exception as e:
            print(f"âš ï¸ README.md æ›´æ–°å¤±æ•—ï¼š{e}")
        
        print("âœ… æ–‡ä»¶æ›´æ–°å®Œæˆ")
        SCRIPT_EOF
        
        python update_workflows.py
        
    - name: Update version scripts
      run: |
        echo "ğŸ”„ æ›´æ–°ç‰ˆæœ¬è…³æœ¬..."
        
        cat > update_scripts.py << 'SCRIPT_EOF'
        import json
        from datetime import datetime
        
        try:
            with open('latest_versions.json', 'r') as f:
                content = f.read().strip()
                if not content:
                    print('âŒ latest_versions.json æ–‡ä»¶ç‚ºç©º')
                    exit(1)
                versions_data = json.loads(content)
        except FileNotFoundError:
            print('âŒ latest_versions.json æ–‡ä»¶ä¸å­˜åœ¨')
            exit(1)
        except json.JSONDecodeError as e:
            print(f'âŒ JSON è§£æéŒ¯èª¤: {e}')
            exit(1)
        
        complete_versions = [v for v, data in versions_data.items() if data['status'] == 'complete']
        complete_versions.sort(key=lambda x: [int(i) for i in x.split('.')])
        
        # ç”Ÿæˆ shell è…³æœ¬
        cases = []
        for version in complete_versions:
            data = versions_data[version]
            case = f'  "{version}")\n    YARN_VERSION="{data["yarn_mappings"]}"\n    FABRIC_API_VERSION="{data["fabric_api"]}"\n    PAPER_VERSION="{data["paper"]}"\n    DATA_VERSION="{data["data_version"]}"\n    ;;'
            cases.append(case)
        
        versions_str = ', '.join(complete_versions)
        cases_content = '\n'.join(cases)
        
        shell_script = "#!/bin/bash\n\n"
        shell_script += f"# è‡ªå‹•ç”Ÿæˆçš„ç‰ˆæœ¬æ›´æ–°è…³æœ¬ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
        shell_script += f"# æ”¯æ´ç‰ˆæœ¬: {versions_str}\n\n"
        shell_script += "set -e\n\n"
        default_version = complete_versions[-1]
        shell_script += 'MC_VERSION="${1:-' + default_version + '}"\n\n'
        shell_script += "case \"$MC_VERSION\" in\n"
        shell_script += cases_content + "\n"
        shell_script += "  *)\n"
        shell_script += "    echo \"âŒ ä¸æ”¯æ´çš„ç‰ˆæœ¬: $MC_VERSION\"\n"
        shell_script += f"    echo \"æ”¯æ´çš„ç‰ˆæœ¬: {versions_str}\"\n"
        shell_script += "    exit 1\n"
        shell_script += "    ;;\n"
        shell_script += "esac\n\n"
        shell_script += "echo \"ğŸ”§ æ­£åœ¨æ›´æ–°åˆ° Minecraft $MC_VERSION...\"\n\n"
        shell_script += "# æ›´æ–° gradle.properties\n"
        shell_script += "cat > gradle.properties << EOF\n"
        shell_script += "# Done to increase the memory available to gradle.\n"
        shell_script += "org.gradle.jvmargs=-Xmx4G\n\n"
        shell_script += "# Fabric Properties\n"
        shell_script += "minecraft_version=$MC_VERSION\n"
        shell_script += "yarn_mappings=$YARN_VERSION\n"
        shell_script += "loader_version=0.16.9\n\n"
        shell_script += "# Mod Properties\n"
        shell_script += "mod_version=1.0.0-SNAPSHOT\n"
        shell_script += "maven_group=site.chococar\n"
        shell_script += "archives_base_name=chococars-inventory-bridge\n\n"
        shell_script += "# Dependencies\n"
        shell_script += "fabric_version=$FABRIC_API_VERSION\n"
        shell_script += "paper_version=$PAPER_VERSION\n"
        shell_script += "data_version=$DATA_VERSION\n\n"
        shell_script += "# CI/CD Properties\n"
        shell_script += "ci_build=false\n"
        shell_script += "EOF\n\n"
        shell_script += "# æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬\n"
        shell_script += "echo \"ğŸ“ æ›´æ–°é…ç½®æ–‡ä»¶...\"\n"
        shell_script += "find . -name \"*.yml\" -type f -not -path \"./.git/*\" -exec sed -i.bak \"s/minecraftVersion: \\\".*\\\"/minecraftVersion: \\\"$MC_VERSION\\\"/g\" {} \\;\n\n"
        shell_script += "# æ¸…ç†å‚™ä»½æ–‡ä»¶\n"
        shell_script += "find . -name \"*.yml.bak\" -delete\n\n"
        shell_script += "# æ›´æ–°å¸¸é‡æ–‡ä»¶ä¸­çš„æ•¸æ“šç‰ˆæœ¬\n"
        shell_script += "echo \"ğŸ”¢ æ›´æ–°æ•¸æ“šç‰ˆæœ¬...\"\n"
        shell_script += "find . -name \"*.java\" -type f -exec sed -i.bak \"s/CURRENT_DATA_VERSION = [0-9]*/CURRENT_DATA_VERSION = $DATA_VERSION/g\" {} \\;\n"
        shell_script += "find . -name \"*.java.bak\" -delete\n\n"
        shell_script += "echo \"âœ… ç‰ˆæœ¬æ›´æ–°å®Œæˆï¼\"\n"
        shell_script += "echo \"ğŸ“‹ ç•¶å‰é…ç½®ï¼š\"\n"
        shell_script += "echo \"   Minecraft: $MC_VERSION\"\n"
        shell_script += "echo \"   Yarn: $YARN_VERSION\"\n"
        shell_script += "echo \"   Fabric API: $FABRIC_API_VERSION\"\n"
        shell_script += "echo \"   Paper: $PAPER_VERSION\"\n"
        shell_script += "echo \"   Data Version: $DATA_VERSION\"\n"
        shell_script += "echo \"\"\n"
        shell_script += "echo \"ğŸš€ ç¾åœ¨å¯ä»¥é‹è¡Œ './gradlew build' ä¾†æ§‹å»ºå°ˆæ¡ˆ\""
        
        with open('scripts/update-version.sh', 'w') as f:
            f.write(shell_script)
        
        print("âœ… è…³æœ¬æ›´æ–°å®Œæˆ")
        SCRIPT_EOF
        
        python update_scripts.py
        
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add .
        
        if git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
        else
          echo "æäº¤ç‰ˆæœ¬æ›´æ–°..."
          git commit -m "ğŸ”„ è‡ªå‹•æ›´æ–°ç‰ˆæœ¬ API

          æ–°ç‰ˆæœ¬: ${{ needs.check-versions.outputs.new_versions }}
          æ›´æ–°æ™‚é–“: $(date -u)
          
          - æ›´æ–° GitHub Actions å·¥ä½œæµç¨‹
          - æ›´æ–° gradle.properties
          - æ›´æ–°ç‰ˆæœ¬è…³æœ¬
          - æ›´æ–° README.md ç‰ˆæœ¬è³‡è¨Š
          
          ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ"
          
          git push
          
          echo "âœ… ç‰ˆæœ¬æ›´æ–°å·²æäº¤"
          
          # è§¸ç™¼æ§‹å»ºå·¥ä½œæµç¨‹ä¾†é©—è­‰æ–°ç‰ˆæœ¬
          echo "ğŸš€ è§¸ç™¼æ§‹å»ºå·¥ä½œæµç¨‹..."
        fi
        
    - name: Create issue for new versions
      if: needs.check-versions.outputs.new_versions != ''
      uses: actions/github-script@v7
      with:
        script: |
          const newVersions = "${{ needs.check-versions.outputs.new_versions }}".split(' ').filter(v => v);
          
          if (newVersions.length > 0) {
            const issueBody = `
          ## ğŸ‰ åµæ¸¬åˆ°æ–°çš„ Minecraft ç‰ˆæœ¬

          **æ–°ç‰ˆæœ¬:** ${newVersions.join(', ')}

          ### è‡ªå‹•æ›´æ–°å…§å®¹
          - âœ… æ›´æ–° GitHub Actions å·¥ä½œæµç¨‹ç‰ˆæœ¬çŸ©é™£
          - âœ… æ›´æ–° gradle.properties é è¨­ç‰ˆæœ¬
          - âœ… æ›´æ–°ç‰ˆæœ¬åˆ‡æ›è…³æœ¬
          - âœ… æ›´æ–° README.md ç‰ˆæœ¬è³‡è¨Š

          ### éœ€è¦æ‰‹å‹•æª¢æŸ¥
          - [ ] é©—è­‰æ–°ç‰ˆæœ¬çš„ä¾è³´å¯ç”¨æ€§
          - [ ] æ¸¬è©¦æ§‹å»ºæµç¨‹
          - [ ] æ›´æ–°æ–‡æª”ä¸­çš„ç‰ˆæœ¬èªªæ˜
          - [ ] ç¢ºèªå…¼å®¹æ€§è™•ç†æ˜¯å¦éœ€è¦èª¿æ•´

          ### ç›¸é—œé€£çµ
          - [æ§‹å»ºå·¥ä½œæµç¨‹](https://github.com/${{ github.repository }}/actions/workflows/build.yml)
          - [ç‰ˆæœ¬è…³æœ¬](https://github.com/${{ github.repository }}/blob/main/scripts/update-version.sh)

          ---
          *æ­¤ issue ç”± GitHub Actions è‡ªå‹•å‰µå»ºæ–¼ ${new Date().toISOString()}*
          `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ æ–° Minecraft ç‰ˆæœ¬: ${newVersions.join(', ')}`,
              body: issueBody,
              labels: ['enhancement', 'auto-update', 'version-update']
            });
          }

  test-build:
    needs: [check-versions, update-workflows]
    if: needs.check-versions.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout updated repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        
    - name: Test build with new versions
      run: |
        echo "ğŸ§ª æ¸¬è©¦æ–°ç‰ˆæœ¬æ§‹å»º..."
        
        # ç°¡å–®çš„èªæ³•æª¢æŸ¥
        if ! grep -q "minecraft_version:" gradle.properties; then
          echo "âŒ gradle.properties æ ¼å¼éŒ¯èª¤"
          exit 1
        fi
        
        if ! grep -q "minecraft_version:" .github/workflows/build.yml; then
          echo "âŒ build.yml æ ¼å¼éŒ¯èª¤"
          exit 1
        fi
        
        echo "âœ… æ–‡ä»¶æ ¼å¼æª¢æŸ¥é€šé"
        
        # è§¸ç™¼æ¸¬è©¦æ§‹å»ºï¼ˆå¯é¸ï¼‰
        if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
          echo "ğŸš€ è§¸ç™¼æ¸¬è©¦æ§‹å»º..."
          # é€™è£¡å¯ä»¥è§¸ç™¼å¯¦éš›çš„æ§‹å»ºæ¸¬è©¦
        fi
        
        echo "âœ… æ¸¬è©¦å®Œæˆ"

  trigger-build:
    needs: [check-versions, update-workflows, test-build]
    if: needs.check-versions.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Trigger build workflow
      uses: actions/github-script@v7
      with:
        script: |
          console.log('ğŸš€ è§¸ç™¼æ§‹å»ºå·¥ä½œæµç¨‹ä»¥é©—è­‰æ–°ç‰ˆæœ¬...');
          
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'build.yml',
            ref: 'main',
            inputs: {
              release_type: 'snapshot'
            }
          });
          
          console.log('âœ… æ§‹å»ºå·¥ä½œæµç¨‹å·²è§¸ç™¼');